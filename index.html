<script>
// =============================
// Глобальные переменные
// =============================
let products = [];
const orders = [
  { id: "ORD-bytihonmetelkin", date: "20.01.2026", items: [{ name: "Azimut 77 Yacht", price: 3500000 }], total: 3500000 }
];
let cart = [];
let inCart = new Set();
let currentPage = 'main';
let itemToRemove = null;
let currentProductModalId = null;

const pages = {
  main: document.getElementById('main-page'),
  cart: document.getElementById('cart-page'),
  profile: document.getElementById('profile-page'),
  history: document.getElementById('history-page')
};

const modals = {
  product: document.getElementById('product-modal'),
  confirm: document.getElementById('confirm-modal'),
  orderSuccess: document.getElementById('order-success-modal')
};

// =============================
// Вспомогательные функции (без изменений)
// =============================
function transliterate(str) {
  const ru = ["а","б","в","г","д","е","ё","ж","з","и","й","к","л","м","н","о","п","р","с","т","у","ф","х","ц","ч","ш","щ","ъ","ы","ь","э","ю","я"];
  const en = ["a","b","v","g","d","e","e","zh","z","i","y","k","l","m","n","o","p","r","s","t","u","f","kh","ts","ch","sh","shch","","y","","e","yu","ya"];
  let result = str.toLowerCase();
  for (let i = 0; i < ru.length; i++) {
    result = result.replace(new RegExp(ru[i], 'g'), en[i]);
  }
  return result;
}

function shuffleArray(array) {
  const result = [...array];
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
}

function initTheme() {
  const isMobile = window.innerWidth <= 768;
  let saved = localStorage.getItem('theme');
  if (isMobile && !saved) {
    saved = 'light';
    localStorage.setItem('theme', 'light');
  }
  const theme = saved || 'light';
  document.body.setAttribute('data-theme', theme);
  updateThemeIcon(theme);
}

function toggleTheme() {
  const cur = document.body.getAttribute('data-theme');
  const next = cur === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  updateThemeIcon(next);
}

function updateThemeIcon(theme) {
  const pcIcon = document.getElementById('theme-icon');
  if (pcIcon) {
    pcIcon.src = theme === 'dark'
      ? 'images/icons/sun.svg'
      : 'images/icons/moon.svg';
  }
}

function showNotification(msg) {
  const n = document.getElementById('notification');
  if (n) {
    n.textContent = msg;
    n.classList.add('show');
    setTimeout(() => n.classList.remove('show'), 3000);
  }
}

function openModal(m) {
  if (!m) return;
  m.style.display = 'flex';
  setTimeout(() => m.classList.add('active'), 10);
}

function closeModal(m) {
  if (!m) return;
  m.classList.remove('active');
  setTimeout(() => m.style.display = 'none', 300);
}

function navigateTo(page) {
  Object.values(pages).forEach(p => {
    if (p) p.classList.remove('active');
  });
  const targetPage = pages[page];
  if (targetPage) {
    setTimeout(() => {
      targetPage.classList.add('active');
      currentPage = page;
    }, 10);
  }
}

function loadCart() {
  try {
    return JSON.parse(localStorage.getItem('luxuryCart')) || [];
  } catch (e) {
    return [];
  }
}

function saveCart() {
  try {
    localStorage.setItem('luxuryCart', JSON.stringify(cart));
  } catch (e) {}
}

function createBoughtSVG() {
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", "0 0 200 80");
  svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
  svg.style.width = "100%";
  svg.style.height = "100%";

  const textShadow = document.createElementNS(svgNS, "text");
  textShadow.setAttribute("x", "50%");
  textShadow.setAttribute("y", "53%");
  textShadow.setAttribute("text-anchor", "middle");
  textShadow.setAttribute("dominant-baseline", "middle");
  textShadow.setAttribute("fill", "black");
  textShadow.setAttribute("font-weight", "bold");
  textShadow.setAttribute("font-size", "26");
  textShadow.setAttribute("font-family", "Arial, sans-serif");
  textShadow.setAttribute("transform", "scale(1.02)");
  textShadow.textContent = "BOUGHT";

  const text = document.createElementNS(svgNS, "text");
  text.setAttribute("x", "50%");
  text.setAttribute("y", "50%");
  text.setAttribute("text-anchor", "middle");
  text.setAttribute("dominant-baseline", "middle");
  text.setAttribute("fill", "white");
  text.setAttribute("font-weight", "bold");
  text.setAttribute("font-size", "26");
  text.setAttribute("font-family", "Arial, sans-serif");
  text.setAttribute("stroke", "black");
  text.setAttribute("stroke-width", "0.5");
  text.textContent = "BOUGHT";

  svg.appendChild(textShadow);
  svg.appendChild(text);
  return svg;
}

// =============================
// ОСНОВНАЯ ИЗМЕНЁННАЯ ФУНКЦИЯ: renderProducts
// =============================
function renderProducts() {
  const grid = document.getElementById('products-grid');
  if (!grid) return;

  let searchLower = '';
  if (window.innerWidth > 768) {
    searchLower = document.getElementById('search-input-pc')?.value.trim().toLowerCase() || '';
  } else {
    searchLower = document.getElementById('search-input-mobile')?.value.trim().toLowerCase() || '';
  }
  const searchTranslit = transliterate(searchLower);

  // Получаем состояние фильтров
  const yachtChecked = document.getElementById('yacht-filter')?.checked || false;
  const planeChecked = document.getElementById('plane-filter')?.checked || false;
  const mansionChecked = document.getElementById('mansion-filter')?.checked || false;
  const islandChecked = document.getElementById('island-filter')?.checked || false;
  const noFilterSelected = !yachtChecked && !planeChecked && !mansionChecked && !islandChecked;

  grid.innerHTML = '';
  const shuffledProducts = shuffleArray(products);
  shuffledProducts.forEach(p => {
    // Определяем, попадает ли товар под выбранные фильтры
    let showProduct = false;
    if (noFilterSelected) {
      showProduct = true;
    } else {
      if (p.type === 'Yacht' && yachtChecked) showProduct = true;
      if (p.type === 'Plane' && planeChecked) showProduct = true;
      if (p.type === 'Mansion' && mansionChecked) showProduct = true;
      if (p.type === 'Island' && islandChecked) showProduct = true;
    }

    // Поиск по названию
    if (searchLower) {
      const titleLower = p.title.toLowerCase();
      const matchesOriginal = titleLower.includes(searchLower);
      const matchesTranslit = titleLower.includes(searchTranslit);
      if (!matchesOriginal && !matchesTranslit) {
        showProduct = false;
      }
    }

    if (showProduct) {
      const isInCart = inCart.has(p.id);
      const card = document.createElement('div');
      card.className = 'product-card';
      if (isInCart) {
        card.classList.add('product-in-cart');
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'product-image-wrapper';
      const img = document.createElement('img');
      img.src = p.image;
      img.alt = p.title;
      img.className = 'product-image';
      img.onerror = function() {
        this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgODAwIDE4MCIgZmlsbD0ibm9uZSI+PGNpcmNsZSBjeD0iNDAwIiBjeT0iOTAiIHI9IjcwIiBmaWxsPSJsaWdodGdyZWVuIi8+PC9zdmc+';
      };
      wrapper.appendChild(img);

      if (isInCart) {
        const overlay = document.createElement('div');
        overlay.className = 'bought-svg-overlay';
        overlay.appendChild(createBoughtSVG());
        wrapper.appendChild(overlay);
      }

      const info = document.createElement('div');
      info.className = 'product-info';
      // ⚠️ Используем p.type вместо p.category
      info.innerHTML = `
        <div class="product-category">${p.type.toUpperCase()}</div>
        <div class="product-title">${p.title}</div>
        <div class="product-price">$${p.price.toLocaleString()}</div>
      `;
      card.appendChild(wrapper);
      card.appendChild(info);

      if (!isInCart) {
        card.addEventListener('click', () => openProductModal(p.id));
      }

      grid.appendChild(card);
    }
  });
}

// =============================
// ОБНОВЛЁННАЯ: openProductModal
// =============================
function openProductModal(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;

  const imgEl = document.getElementById('modal-product-image');
  const titleEl = document.getElementById('modal-product-title');
  const catEl = document.getElementById('modal-product-category');
  const descEl = document.getElementById('modal-product-description');
  const priceEl = document.getElementById('modal-product-price');

  if (imgEl) imgEl.style.backgroundImage = `url(${p.image})`;
  if (titleEl) titleEl.textContent = p.title;
  // ⚠️ Отображаем type как категорию
  if (catEl) catEl.textContent = p.type.toUpperCase();
  if (descEl) descEl.textContent = p.description;
  if (priceEl) priceEl.textContent = `$${p.price.toLocaleString()}`;

  currentProductModalId = id;
  openModal(modals.product);
}

// =============================
// Остальные функции без изменений
// =============================
function addToCart(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;

  inCart.add(id);
  renderProducts();

  const ex = cart.find(i => i.id === id);
  if (ex) {
    ex.quantity++;
  } else {
    cart.push({ id: p.id, name: p.title, price: p.price, quantity: 1 });
  }

  saveCart();
  renderCart();
  showNotification(`${p.title} added to cart`);
}

function removeFromCart(id) {
  cart = cart.filter(i => i.id !== id);
  inCart.delete(id);
  saveCart();
  renderCart();
  renderProducts();
  closeModal(modals.confirm);
  showNotification('Item removed from cart');
}

function renderCart() {
  const c = document.getElementById('cart-items');
  const t = document.getElementById('cart-total');
  if (!c || !t) return;

  c.innerHTML = '';
  if (cart.length === 0) {
    c.innerHTML = '<p style="text-align:center; padding:24px; color:var(--text-secondary);">Your cart is empty</p>';
    t.textContent = 'Total: $0';
    return;
  }

  let total = 0;
  cart.forEach(i => {
    total += i.price * i.quantity;
    const el = document.createElement('div');
    el.className = 'order-card';
    el.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: bold;">${i.name}</div>
          <div style="color: var(--text-secondary);">$${i.price.toLocaleString()} × ${i.quantity}</div>
        </div>
        <button class="back-button" style="padding:5px 12px; font-size:14px;" data-id="${i.id}">Remove</button>
      </div>
    `;
    c.appendChild(el);
  });

  t.textContent = `Total: $${total.toLocaleString()}`;
  document.querySelectorAll('[data-id]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      itemToRemove = parseInt(btn.dataset.id);
      openModal(modals.confirm);
    });
  });
}

function renderOrders() {
  const list = document.getElementById('orders-list');
  if (!list) return;
  list.innerHTML = '';
  orders.forEach(o => {
    const el = document.createElement('div');
    el.className = 'order-card';
    let itemsHtml = o.items.map(i => `<div style="margin:5px 0;">• ${i.name}</div>`).join('');
    el.innerHTML = `
      <div class="order-header">
        <div class="order-number">${o.id}</div>
        <div class="order-date">${o.date}</div>
      </div>
      <div style="margin:12px 0;">${itemsHtml}</div>
      <div class="order-total">Total: $${o.total.toLocaleString()}</div>
    `;
    list.appendChild(el);
  });
}

function checkout() {
  if (cart.length === 0) return showNotification('Your cart is empty');
  const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);
  const orderId = 'ORD-' + Math.floor(Math.random() * 1000000000);
  const numEl = document.getElementById('order-number');
  const amtEl = document.getElementById('order-total-amount');
  if (numEl) numEl.textContent = orderId;
  if (amtEl) amtEl.textContent = `$${total.toLocaleString()}`;

  cart = [];
  inCart.clear();
  saveCart();
  renderCart();
  renderProducts();
  openModal(modals.orderSuccess);
}

function saveProfile() {
  const name = document.getElementById('profile-name')?.value.trim();
  const email = document.getElementById('profile-email')?.value.trim();
  if (!name || !email) return showNotification('Please fill in all fields');
  showNotification('Profile saved successfully');
}

function safeSetupAutocomplete(inputId, suggestionsId) {
  const input = document.getElementById(inputId);
  const sug = document.getElementById(suggestionsId);
  if (!input || !sug) return;

  input.addEventListener('input', () => {
    const term = input.value.trim();
    if (!term) return sug.style.display = 'none';

    const termLower = term.toLowerCase();
    const termTranslit = transliterate(termLower);
    const matches = products.filter(p =>
      p.title.toLowerCase().includes(termLower) ||
      p.title.toLowerCase().includes(termTranslit)
    ).slice(0, 5);

    if (matches.length === 0) return sug.style.display = 'none';

    sug.innerHTML = '';
    matches.forEach(p => {
      const div = document.createElement('div');
      div.textContent = p.title;
      div.style.padding = '12px 20px';
      div.style.cursor = 'pointer';
      div.style.color = 'var(--text-color)';
      div.style.fontSize = '16px';
      div.addEventListener('mouseenter', () => div.style.backgroundColor = 'var(--border-color)');
      div.addEventListener('mouseleave', () => div.style.backgroundColor = 'transparent');
      div.addEventListener('click', () => {
        input.value = p.title;
        sug.style.display = 'none';
        renderProducts();
      });
      sug.appendChild(div);
    });
    sug.style.display = 'block';
  });

  document.addEventListener('click', e => {
    if (e.target !== input && !sug.contains(e.target)) sug.style.display = 'none';
  });
}

function setupEventListeners() {
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  document.getElementById('cart-icon').addEventListener('click', () => navigateTo('cart'));
  document.getElementById('profile-icon').addEventListener('click', () => navigateTo('profile'));
  document.getElementById('history-icon').addEventListener('click', () => navigateTo('history'));

  document.getElementById('search-icon').addEventListener('click', () => {
    const input = window.innerWidth > 768
      ? document.getElementById('search-input-pc')
      : document.getElementById('search-input-mobile');
    if (input) {
      input.focus();
      input.classList.add('search-highlight');
      setTimeout(() => input.classList.remove('search-highlight'), 2000);
    }
  });

  document.querySelector('.logo').addEventListener('click', () => navigateTo('main'));
  document.getElementById('back-from-cart').addEventListener('click', () => navigateTo('main'));
  document.getElementById('back-from-profile').addEventListener('click', () => navigateTo('main'));
  document.getElementById('back-from-history').addEventListener('click', () => navigateTo('main'));
  document.getElementById('reset-filters').addEventListener('click', () => {
    document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
    renderProducts();
  });
  document.getElementById('close-product-modal').addEventListener('click', () => closeModal(modals.product));
  document.getElementById('modal-add-to-cart').addEventListener('click', () => {
    addToCart(currentProductModalId);
    closeModal(modals.product);
  });
  document.getElementById('close-modal').addEventListener('click', () => closeModal(modals.confirm));
  document.getElementById('cancel-delete').addEventListener('click', () => closeModal(modals.confirm));
  document.getElementById('confirm-delete').addEventListener('click', () => {
    if (itemToRemove !== null) removeFromCart(itemToRemove);
  });
  document.getElementById('close-success-modal').addEventListener('click', () => {
    closeModal(modals.orderSuccess); navigateTo('main');
  });
  document.getElementById('checkout-button').addEventListener('click', checkout);
  document.getElementById('save-profile').addEventListener('click', saveProfile);
  document.querySelectorAll('.filter-checkbox').forEach(cb => {
    cb.addEventListener('change', renderProducts);
  });
  window.addEventListener('click', e => {
    if (modals.product && e.target === modals.product) closeModal(modals.product);
    if (modals.confirm && e.target === modals.confirm) closeModal(modals.confirm);
    if (modals.orderSuccess && e.target === modals.orderSuccess) {
      closeModal(modals.orderSuccess); navigateTo('main');
    }
  });
}

// =============================
// ЗАГРУЗКА ДАННЫХ
// =============================
document.addEventListener('DOMContentLoaded', () => {
  fetch('data.json')
    .then(response => {
      if (!response.ok) throw new Error('Failed to load data.json');
      return response.json();
    })
    .then(data => {
      // ⚠️ ВАЖНО: ваш JSON имеет объект с ключом "products"
      products = data.products;
      cart = loadCart();
      // Инициализация состояния корзины
      cart.forEach(item => inCart.add(item.id));
      initTheme();
      renderProducts();
      renderCart();
      renderOrders();
      setupEventListeners();

      // Поиск
      document.getElementById('search-clear-pc').addEventListener('click', () => {
        document.getElementById('search-input-pc').value = '';
        renderProducts();
      });
      document.getElementById('search-input-pc').addEventListener('input', renderProducts);
      document.getElementById('search-input-mobile').addEventListener('input', renderProducts);
      safeSetupAutocomplete('search-input-pc', 'suggestions');
      safeSetupAutocomplete('search-input-mobile', 'suggestions');

      // Приветствие
      if (!localStorage.getItem('luxury_welcome_shown')) {
        setTimeout(() => {
          document.getElementById('welcome-modal').classList.add('active');
        }, 500);
      }
    })
    .catch(error => {
      console.error('Error loading products:', error);
      document.getElementById('products-grid').innerHTML = '<p style="text-align:center; color:red;">Failed to load products.</p>';
    });
});

// Обработчики вне DOMContentLoaded
document.getElementById('close-welcome').addEventListener('click', () => {
  document.getElementById('welcome-modal').classList.remove('active');
  localStorage.setItem('luxury_welcome_shown', 'true');
});

document.getElementById('help-button').addEventListener('click', () => {
  Object.values(modals).forEach(m => { m.classList.remove('active'); m.style.display = 'none'; });
  document.getElementById('order-success-modal').classList.remove('active');
  document.getElementById('order-success-modal').style.display = 'none';
  document.getElementById('video-modal').classList.add('active');
});

document.getElementById('close-video').addEventListener('click', () => {
  document.getElementById('video-modal').classList.remove('active');
});

document.getElementById('video-modal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('video-modal')) {
    document.getElementById('close-video').click();
  }
});
</script>
